# 常见问题处理

## 第一部分 基础操作

### 第一章 AGV 设备基础操作

#### 1.1 设备连接方法

- 远程ssh连接
  - 使用 CMD 或 MobaXterm 软件，使用 ssh 连接，连接上后可进行终端操作，设备为 Ubuntu 系统，需自行学习 linux 相关基础知识。
  - 例：```ssh dahua@10.68.177.41```
  - 在连接后需要输入密码：```123$iRAY567*```
- 设备有线直连
  - usb端连接设备
    - 需修改电脑网段与 10.35.36.250 位于同一网段
      - 修改电脑网段的操作步骤：设置 > 网络和 Internet > 高级网络设置 > 相关设置 > 更多网络适配器选项
      - 找到有线连接对应的以太网
      - 更改 Internet 协议版本 4（TCP/IPv4）
      - 使用下面的 IP 地址（S）：

    描述|配置地址
    :--:|--
    IP 地址  （I）：|10.35.36.111
    子网掩码  （U）：|255.255.255.0
    默认网关  （D）：|10.35.36.254     （默认为 0.0.0.0）

    - 例：
      - 修改电脑网段为 10.35.36.111 后进行 ssh 连接操作
      - ```ssh dahua@10.35.36.250```
  - 网线端连接设备
    - 需修改电脑网段与 192.168.23.1 位于同一网段
    - 例：
      - 修改电脑网段为 192.168.23.111 后进行 ssh 连接操作
      - ```ssh dahua@192.168.23.1```

#### 1.2 systools 工具

在输入 systools 后可以看到介绍

``` bash
[10.68.176.12]@~$ systools
系统工具箱，集成系统调试相关工具。使用：systools [OPTION]
        net     --> 网络状态
        camera  --> 相机状态
        laser   --> 激光状态
        tof     --> TOF状态
        upgrade --> 升级异常排查
        boot    --> 系统启动和关闭记录
        hist    --> 命令执行记录
        h2offt  --> 更新bios版本到APL_Z09_CAMERA_T8G_26_SVID.bin
        backup  --> 将设备私有数据(标定数据等)压缩打包到当前目录
        dev5g   --> 检查当前设备中5G模组的状态

```

可以使用该工具简单查看设备情况

```bash
[10.68.176.12]@~$ systools net
1. RTL8821AU模块硬件已经识别
2. 无线网络连接成功
3. SSID: dahuaagv_5g
4. IP: 10.68.176.12 mask: 255.255.252.0 路由: 10.68.179.254
5. 信号良好，信号强度 RSSI: -38
6. NetApp已开启
  |-- 设备路由与Netapp设置是一致
  |-- 设备IP与Netapp设置是一致
7. 频段 Frequency: 5.745 信道： 信道扫描个数：9

```

#### 1.3 设备网络相关操作

##### linux 查看网络命令：ifconfig

```bash
wlan0     Link encap:Ethernet  HWaddr 40:24:b2:2a:1a:d4
          inet addr:10.68.176.12  Bcast:10.68.179.255  Mask:255.255.252.0
          inet6 addr: fe80::4224:b2ff:fe2a:1ad4/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:137050 errors:0 dropped:2 overruns:0 frame:0
          TX packets:115745 errors:0 dropped:16 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:16836686 (16.8 MB)  TX bytes:66466401 (66.4 MB)
```

##### linux 查看路由表命令：route -n

```bash
[10.68.176.12]@~$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.68.179.254   0.0.0.0         UG    0      0        0 wlan0
10.68.176.0     0.0.0.0         255.255.252.0   U     0      0        0 wlan0
192.168.23.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0

```

##### 打开漫游操作

需要学习 vim 相关操作

```bash
setcfg RobotWifiConfig
```

```bash
"{\"ChannelMode\":112,\"Roam\":true,\"RssiDiff\":6,\"RssiThreshold\":45,\"ScanExp\"\
  :300,\"ScanInterval\":0,\"ScanParam\":100}\n"

```

ChannelMode 值修改 115 或需要信道数
Roadm 值修改为 true

##### 配网相关操作

配网操作步骤

1. 执行清配动作
   - 物理清配
     - 设备实体在手动控制面板下有一个轮胎释能按钮，旁边有一个隐藏的类似按钮，长按后设备会提示清配操作（如无法按到，请使用工具辅助）
   - 程序清配
     - ssh登录设备（带显示屏设备可直接看到 ip 地址）
     - 执行以下命令（进入最高权限，清配操作）

    ```bash
    su
    resetcfg
    ```

2. 使用对应 AGV 配网工具进行配网（配网失败可能与工具版本不对应有关）

#### 1.4 导航日志 nav-parse

#### 1.5 AGV 设备常用指令

指令|注释
-|-

### 第二章 平台

#### 第一部分平台相关功能

##### 配置管理 - 任务配置 - 充电配置 - 按电量充电策略配置

![image-20240514113401487](D:\VScode\gitcode\JieIYu_Markdown_1\问题记录\常见问题及解决方法\RCS及AGV常见问题处理.assets\image-20240514113401487.png)

- 空闲充电策略
  - 对充电桩对接失败概率较大的现场不适用，逻辑为，空闲超过设定时间后，设备会下发一次充电任务，对接充电桩因接触不良原因失败后，只有当设备电量低于开始充电电量时，才会有重试操作，启用空闲充电可能导致设备来回空跑。

##### 配置管理 - 货架配置 - 货架配置

![image-20240514113523114](D:\VScode\gitcode\JieIYu_Markdown_1\问题记录\常见问题及解决方法\RCS及AGV常见问题处理.assets\image-20240514113523114.png)

主要对货架进行管理，如有异常任务，人工处理完货架后，需要重新绑定货架位置。

### 第三章 服务器（需要堡垒机权限）

## 第二部分 问题排查相关方法

### 第四章 脱轨问题

#### 1. 平台查找报警消息

例：算法未规划路径
![Alt text](b81862ead2459a0ce4079f849550f3f0.png)

算法未规划路径的其中一个可能原因是脱轨，一般二维码设备没有开启自由导航功能，无法重新回到轨道，因此脱轨后会导致设备在路线外，从而导致算法无法规划路径。

#### 2. 设备查看脱轨录像

ssh连接设备后查看，建议使用 MobaXterm，可以直接打开该文件查看

二维码设备脱轨建议现场人员直接查看二维码脱轨录像。脱轨前我们会存放 10 秒以上
的录像。录像存放地址为

```bash
/var/robot/log/nav/bag/xx-yy/derail/derail_aa.bb.cc.avi
```

其中的 xx-yy 是月和日期，aa.bb.cc 是时间，比如

```bash
/var/robot/log/nav/bag/08-16/derail/derail_14.43.05.avi
```

就是 8 月 16 日 14 点 43 分 05 秒上报的脱轨的录像。

一般观看录像可以发现码过歪或损坏导致的脱轨问题，远程指导解决即可。

#### 3. 现场综合排查问题原因

平台发送空车移动，观察设备是否在脱轨点往一个方向偏，最终没有扫到终点码，重复多次结果一致则可判断为二维码导致，调整该码的角度，偏置约1°左右，再次观察设备运行情况。

转弯点及充电桩对接时要求精度一般较高，需要多次调整。

### 第五章 遇障问题

### 1. 地图问题——线避障、点避障

记录遇障时设备所在点位，使用地图工具进行修改避障方案

### 2. 设备问题 ——点避障

## 第三部分 服务器相关部分

### 服务器升级

#### 3.0 服务器升级 4.2

##### 迁移数据库

>数据库需要相应软件和权限，需找相关负责人获取。

以 Navicat 为例

###### Navicat 基础操作

###### 需要通过迁移的几张表

- 设备相关 （迁移后可通过 setcfg 进行设备切服务器操作，而不需要重新配网）
  - agv_model 设备模型表
  - agv_model_init 设备模型初始化表
    - 与 agv_model 表中的 id 需要一一对应，否则会出现报错
  - agv_robot 设备表
    - 为添加到平台中的所有设备
  - agv_robot_ext 设备所在区域表
    - 记录设备所在区域
    - 记录设备编号
- 任务相关 （尽可能通过客户端重新配置同名模版，配置量一般不大）
- 呼叫器相关 （迁移呼叫器后需要同步删除原服务器对应记录）
  - cis_config 呼叫器网关连接配置，配置后平台才能连接到呼叫器网关
  - device_call 平台上的单个呼叫器配置，亦可在平台配置，版本不同需注意是否有字段缺失

##### 注意事项

地图问题

- 3.0 地图直接导入 4.2 版本中，可能导致部分设备提示地图格式不对。
  - 解决方法：使用新版地图工具打开，导出为 JSON 文件，然后删除所有点位，导入 JSON 后保存，使用该地图导入客户端。
- 3.0 地图弧线与 4.2 版本中弧线有所不同，可能导致设备离线，无法通过等问题，解决方法为地图编辑器中优化弧线或重新绘制弧线。
  - 优化方法为：地图配置 -> 策略应用 -> 弧线调整 -> 弧线自动相切，弧线调整。
  - 检查弧线是否存在角度错误。

## 附录

### 1. 设备错误码

内部错误码|错误描述
-|-
0x201a|设备故障而停止
0x3002|因碰撞停止
0x3005|因按下紧急制动按钮而停止
0x3006|因底层电机相关异常停止
0x3202|路径不合法
0x3203|任务被取消
0x3207|脱轨
0x3014|未知——任务
0x811|入弧角与当前夹角过大
